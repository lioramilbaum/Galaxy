{
	"variables": {
		"aws_access_key": "{{env `aws_access_key`}}",
		"aws_secret_key": "{{env `aws_secret_key`}}",
		"chef_dir": "/tmp/packer-chef-client",
		"conf_dir": "/etc/chef/"
	},
	"builders": [
		{
			"type": "amazon-ebs",
			"access_key": "{{user `aws_access_key`}}",
			"secret_key": "{{user `aws_secret_key`}}",
			"region": "eu-west-1",
			"source_ami": "ami-60a10117",
			"security_group_id": "sg-e5861e93",
			"ssh_username": "ubuntu",
			"instance_type": "m3.xlarge",
			"ami_name": "clm {{timestamp}}",
			"ami_block_device_mappings": [
    			{
    				"device_name": "/dev/sda1",
    				"volume_size": 100,
    				"delete_on_termination": true
				}
			],
			"launch_block_device_mappings": [
        		{
					"device_name": "/dev/sda1",
					"volume_size": 100,
					"delete_on_termination": true
				}
			]
		}
	],
	"provisioners": [
  	{ "type": "file", "source": "/packer/nodes", "destination": "{{user `chef_dir`}}" },
    { "type": "file", "source": "/packer/environments", "destination": "{{user `chef_dir`}}" },
    { "type": "file", "source": "/packer/cookbooks", "destination": "{{user `chef_dir`}}" },
    { "type": "file", "source": "/packer/Berksfile", "destination": "{{user `chef_dir`}}/Berksfile" },
    { "type": "file", "source": "/packer/scripts", "destination": "." },
    {
    	"type": "shell",
    	"script": "./scripts/install_berks.sh"
    }, 
    {
    	"type": "shell",
    	"inline": ["berks vendor -b /tmp/packer-chef-client/Berksfile /tmp/chef-cookbooks"]
    }, 
    {
      "type": "chef-client",
      "chef_environment": "{{user `chef_env`}}",
      "server_url": "http://localhost:8889",
      "config_template": "/packer/templates/client.rb.template",
      "skip_clean_node": true,
      "skip_clean_client": true,
      "run_list": [ "CLM::default" ]
    }
  ],
  "push": {
    "name": "ATLAS_USERNAME/liora"
  },
  "post-processors": [
    {
      "type": "atlas",
      "artifact": "ATLAS_USERNAME/liora",
      "artifact_type": "amazon.ami"
    }
  ]
}