{
	"variables": {
		"galaxy_dir": "/packer",
		"aws_access_key": "{{env `aws_access_key`}}",
		"aws_secret_key": "{{env `aws_secret_key`}}",
		"chef_dir": "/tmp/packer-chef-client",
		"conf_dir": "/etc/chef/"
	},
	"builders": [
		{
			"type": "amazon-ebs",
			"access_key": "{{user `aws_access_key`}}",
			"secret_key": "{{user `aws_secret_key`}}",
			"region": "eu-west-1",
			"source_ami": "ami-60a10117",
			"ssh_username": "ubuntu",
			"instance_type": "t2.small",
			"ami_name": "base {{timestamp}}",
			"associate_public_ip_address": true,
			"ami_virtualization_type": "hvm",
			"vpc_id": "vpc-7dd90818", 
			"subnet_id": "subnet-7cf03b25",
			"security_group_id": "sg-66dc4703",
			"ssh_private_ip": false
		}
	],
	"provisioners": [
  		{ "type": "file", "source": "{{user `galaxy_dir`}}/nodes", "destination": "{{user `chef_dir`}}" },
    	{ "type": "file", "source": "{{user `galaxy_dir`}}/environments", "destination": "{{user `chef_dir`}}" },
    	{ "type": "file", "source": "{{user `galaxy_dir`}}/cookbooks", "destination": "{{user `chef_dir`}}" },
    	{ "type": "file", "source": "{{user `galaxy_dir`}}/Berksfile", "destination": "{{user `chef_dir`}}/Berksfile" },
		{ "type": "file", "source": "{{user `galaxy_dir`}}/metadata.rb", "destination": "{{user `chef_dir`}}/metadata.rb" },
		{ "type": "file", "source": "{{user `galaxy_dir`}}/scripts", "destination": "." },
		{
			"type": "shell",
			"script": "./scripts/install_berks.sh"
		}, 
		{
			"type": "shell",
			"inline": ["berks vendor -b /tmp/packer-chef-client/Berksfile /tmp/chef-cookbooks"]
		}, 
		{
			"type": "chef-client",
			"chef_environment": "{{user `chef_env`}}",
			"server_url": "http://localhost:8889",
			"config_template": "{{user `galaxy_dir`}}/templates/client.rb.template",
			"skip_clean_node": true,
			"skip_clean_client": true,
			"run_list": [ "CLM::init" ]
		}
	]
}